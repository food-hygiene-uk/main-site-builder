name: Verify the integrity of main branch

# Control concurrent executions
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

# Define trigger events
on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

# Define minimum required permissions
permissions:
  contents: read

jobs:
  command-outputs:
    name: Set "outputs" from command execution
    runs-on: ubuntu-latest
    # Map a step output to a job output
    outputs:
      DENO_VERSION: ${{ steps.commands.outputs.DENO_VERSION }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          sparse-checkout: |
            .deno-version
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Commands
        id: commands
        run: |
          echo "DENO_VERSION=$(cat .deno-version)" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 1200

    permissions:
      contents: write

    needs: [command-outputs]
    env:
      DENO_VERSION: ${{ needs.command-outputs.outputs.DENO_VERSION }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get GitHub App User ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app_slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Create workspace directory
        run: mkdir ./repos/

      - name: Checkout source repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: ./repos/source
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: Ensure SHA pinned actions
        uses: zgosalvez/github-actions-ensure-sha-pinned-actions@6124774845927d14c601359ab8138699fa5b70c3 # v4.0.1

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2.0.3
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Deno install
        working-directory: ./repos/source
        run: deno install

      - name: Run Deno test
        working-directory: ./repos/source
        run: deno test

      - name: Run ESLint
        working-directory: ./repos/source
        run: deno task eslint:check

      - name: Run Deno lint
        working-directory: ./repos/source
        run: deno lint

      - name: Run formatter
        working-directory: ./repos/source
        run: |
          deno task prettier:write ; status=$?
          if [ $status -eq 2 ]; then
            echo "Somethingâ€™s wrong with Prettier."
            exit 2
          fi
          deno fmt
          if [ -n "$(git status --porcelain)" ]; then
            echo "Error: Unformatted files detected. Please commit changes after running the formatter."
            exit 1
          fi

      - name: Run Deno check
        working-directory: ./repos/source
        run: deno check src/generate-site.mts

      - name: Generate ratings site
        working-directory: ./repos/source
        run: deno task build

      - name: Run Playwright tests
        working-directory: ./repos/source
        run: deno task test:e2e

      - name: Upload Playwright report
        if: always() # Upload report even if tests fail
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-report
          path: ./repos/source/playwright-report/
          retention-days: 7
